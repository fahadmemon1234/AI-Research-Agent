from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse

from app.core.logging_config import log_info
from app.api.v1.routes import router as api_router
from app.database.db_setup import init_db
from app.core.websocket_auth import require_active_user_from_websocket
from app.core.auth_middleware import AuthMiddleware

import json
from datetime import datetime
from decimal import Decimal
from pydantic.json import pydantic_encoder


# -------------------------
# Custom JSON Encoder
# -------------------------
class DateTimeEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, datetime):
            return obj.isoformat()
        if isinstance(obj, Decimal):
            return float(obj)
        try:
            return pydantic_encoder(obj)
        except TypeError:
            return str(obj)


class CustomJSONResponse(JSONResponse):
    def render(self, content):
        return json.dumps(
            content,
            cls=DateTimeEncoder,
            ensure_ascii=False
        ).encode("utf-8")


# -------------------------
# FastAPI App Init
# -------------------------
app = FastAPI(
    title="AI Knowledge Assistant API",
    description="API for the AI Knowledge Assistant application",
    version="1.0.0",
    default_response_class=CustomJSONResponse
)


# -------------------------
# CORS - Placed BEFORE Auth Middleware
# -------------------------
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Allow all origins for development
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
    # Add exposed headers to ensure authorization header is accessible
    expose_headers=["Access-Control-Allow-Origin", "Authorization"]
)


# -------------------------
# Authentication Middleware
# -------------------------
# Exclude public endpoints from authentication
excluded_paths = [
    "/",
    "/health",
    "/api/v1/auth/register",
    "/api/v1/auth/login",
    "/docs",
    "/redoc",
    "/openapi.json"
]
app.add_middleware(
    AuthMiddleware,
    excluded_paths=excluded_paths
)


# -------------------------
# Startup
# -------------------------
@app.on_event("startup")
def on_startup():
    init_db()


# -------------------------
# REST Routes
# -------------------------
app.include_router(api_router, prefix="/api/v1")


@app.get("/")
def read_root():
    log_info("Root endpoint accessed")
    return {"message": "Welcome to the AI Knowledge Assistant API"}


@app.get("/health")
def health_check():
    return {
        "status": "healthy",
        "timestamp": "2026-01-21T00:00:00Z"
    }


# -------------------------
# WebSocket Endpoint âœ…
# -------------------------
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()

    user = await require_active_user_from_websocket(websocket)
    if not user:
        return

    log_info(f"WebSocket connected: {user.email}")

    try:
        while True:
            message = await websocket.receive_text()
            await websocket.send_text(
                f"Hello {user.email}: {message}"
            )
    except WebSocketDisconnect:
        log_info(f"WebSocket disconnected: {user.email}")


# -------------------------
# Run App
# -------------------------
if __name__ == "__main__":
    import uvicorn
    uvicorn.run("app.main:app", host="0.0.0.0", port=8000, reload=True)